@using SMEAdapter.Application.DTOs;
@using SMEAdapter.Application.ProductDocuments.AddProductDocuments;
@using MediatR;
@inject IMediator Mediator;

<MudGrid Spacing="3">
    <!-- Document Version -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Outlined="true">
            <MudText Typo="Typo.h6">Document Version</MudText>
            <MudForm @ref="form">
                <MudTextField @bind-Value="NewDocument.Language" Label="Language" />
                <MudTextField @bind-Value="NewDocument.Version" Label="Version" />
                <MudTextField @bind-Value="NewDocument.Title" Label="Title" />
                <MudTextField @bind-Value="NewDocument.Summary" Label="Summary" Lines="3" />
                <MudTextField @bind-Value="NewDocument.Keywords" Label="Keywords" />
                <MudTextField @bind-Value="NewDocument.State" Label="State" />
                <MudDatePicker @bind-Date="NewDocument.StateDate" Label="State Date" />
                <MudTextField @bind-Value="NewDocument.OrganisationName" Label="Organisation Name" />
                <MudTextField @bind-Value="NewDocument.OrganisationOfficialName" Label="Organisation Official Name" />
            </MudForm>
        </MudPaper>
    </MudItem>

    <!-- Document Identifier -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Outlined="true">
            <MudText Typo="Typo.h6">Document Identifier</MudText>
            <MudTextField @bind-Value="NewDocument.ValueId" Label="Value ID" />
            <MudTextField @bind-Value="NewDocument.DomainId" Label="Domain ID" />
        </MudPaper>
    </MudItem>

    <!-- Document Classification -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Outlined="true">
            <MudText Typo="Typo.h6">Document Classification</MudText>
            <MudTextField @bind-Value="NewDocument.ClassificationSystem" Label="Classification System" />
            <MudTextField @bind-Value="NewDocument.ClassName" Label="Class Name" />
            <MudTextField @bind-Value="NewDocument.ClassLang" Label="Class Language" />
            <MudTextField @bind-Value="NewDocument.ClassDescription" Label="Class Description" />
            <MudTextField @bind-Value="NewDocument.ClassId" Label="Class ID" />
        </MudPaper>
    </MudItem>

    <!-- File Upload -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Outlined="true">
            <MudText Typo="Typo.h6">File Upload</MudText>
            <MudFileUpload T="IBrowserFile" MaximumFileCount="1" FilesChanged="FileUploaded">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        Upload File
                    </MudButton>
                </ActivatorContent>
                <SelectedTemplate>
                    @if (context != null)
                    {
                        <MudText>@context.Name</MudText>
                    }
                    else
                    {
                        <MudText>No File</MudText>
                    }
                </SelectedTemplate>
            </MudFileUpload>

        </MudPaper>
    </MudItem>

    <!-- Save Button -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Outlined="true">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="@(!fileUploaded)"
                       OnClick="SaveDocument">
                Save
            </MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public Guid ProductId { get; set; }
    [Parameter] public EventCallback<ProductDocumentDto> OnSaved { get; set; }
    private bool fileUploaded = false;
    IList<IBrowserFile> _files = new List<IBrowserFile>();
    private MudForm? form;
    private ProductDocumentDto NewDocument = new();
    private IBrowserFile? _selectedFile;

    private async Task FileUploaded(IBrowserFile files)
    {
        _selectedFile = files;
        fileUploaded = _selectedFile is not null;
    }

    private async Task SaveDocument()
    {
        if (_selectedFile is null)
            return;

        using var ms = new MemoryStream();
        await _selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024).CopyToAsync(ms);
        var fileBytes = ms.ToArray();

        NewDocument.ProductId = ProductId;
        NewDocument.StateDate = DateTime.UtcNow;
        NewDocument.FileName = _selectedFile.Name;
        NewDocument.ContentType = _selectedFile.ContentType;
        NewDocument.Data = fileBytes;

        await Mediator.Send(new AddProductDocumentCommand(NewDocument));
        await OnSaved.InvokeAsync(NewDocument);

        // Reset state
        NewDocument = new();
        _selectedFile = null;
        fileUploaded = false;
    }
}