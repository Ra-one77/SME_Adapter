@page "/testpage/{productId:guid}" 


@inject NavigationManager Navigate;
@using MediatR;
@inject IMediator Mediator;
@using SMEAdapter.Application.DTOs;
@using SMEAdapter.Application.ProductDocuments.AddProductDocuments;
@using SMEAdapter.Application.ProductDocuments.GetProductDocuments;



<MudGrid Class="pa-2" Spacing="3">
    <!-- Header + Add Form -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="2">
                <MudStack Direction="Row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h5">Add your Documents here</MudText>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ToggleAddForm">
                        @(showAddForm ? "Cancel" : "Add Document")
                    </MudButton>
                </MudStack>

                @if (showAddForm)
                {
                    <AddDocumentForm ProductId="ProductId" OnSaved="HandleSaved" />
                }
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Table -->
    <MudItem xs="12">
        <MudPaper Class="pa-4 mt-2" Elevation="1">
            @if (!showAddForm)
            {
                <!-- Table -->
                <MudTable Items="@documents" Dense="true" Hover="true" Striped="true" Outlined="true" Bordered="true">
                    <HeaderContent>
                        <MudTh>S.No</MudTh>
                        <MudTh>File Name</MudTh>
                        <MudTh>Title</MudTh>
                        <MudTh>Uploaded</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="S.No">@(documents.IndexOf(context) + 1)</MudTd>
                        <MudTd DataLabel="File Name">@context.FileName</MudTd>
                        <MudTd Datalabel="Title">@context.Title</MudTd>
                        <MudTd DataLabel="Uploaded">@context.StateDate?.ToShortDateString()</MudTd>
                    </RowTemplate>
                </MudTable>
              
                <MudItem xs="12" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="GoBack">
                        Back to Products
                    </MudButton>

                </MudItem>
            }
            
        </MudPaper>
    </MudItem>
   
</MudGrid>
   




@code {

    [Parameter]
    public Guid ProductId { get; set; }
  
    private List<ProductDocumentDto> documents = new();
    
    private bool showAddForm = false;

    private void ToggleAddForm()
    {
        showAddForm = !showAddForm;
    }

    private async Task HandleSaved(ProductDocumentDto dto)
    {
        await LoadDocuments();
        showAddForm = false;
        
        
    }



    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        var docs = await Mediator.Send(new GetProductDocumentCommand(ProductId));

        documents = docs.ToList();   // assign the DTOs to your table source

        StateHasChanged();
    }

   
    private int rowNumber = 0;

    private void GoBack()
    {
        Navigate.NavigateTo("/viewproducts");
    }

    
}
